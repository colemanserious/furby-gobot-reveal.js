<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Furby: "Go" away!</title>

		<meta name="description" content="A walk through Go programming via the Gobot framework.  We connect a Furby up via Raspberry Pi through Gobot to let programmers be yelled out by a Furby when a Jenkins job breaks.">
		<meta name="author" content="Tina Coleman @colemanserious">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/league.css" id="theme">
		<link rel="stylesheet" href="css/furby.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<style type='text/css'>
		      .reveal #talk-tag {
		        position:   fixed;
		        z-index:    30;
		        bottom:     10px;
		        right:      150px;
		        padding:    0.25%;
		        max-width:  130px;
		        outline:    none;
		        box-shadow: none;
		        background: transparent;
		      }
		 </style>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section data-background="img/8317241259_e0cde4b40a_b.jpg" data-state="dim">
					<h1>Furby: "Go" Away!</h1>
					<h3>Jenkins Furby Ravings via Gobot and Go</h3>
					<p>&nbsp;</p>
					<p>&nbsp;</p>

					<p>
						Furby zoology by <a href="http://www.nerderypublic.com">Tina Coleman</a> | <a href="http://twitter.com/colemanserious">@colemanserious</a> |
						<a href="mailto:tina@haydensoft.com">tina@haydensoft.com</a>
					</p>
					<aside class="notes">

				Image: <a href="https://creativecommons.org/licenses/by/2.0/">Some rights reserved</a> by <a href="https://www.flickr.com/photos/whatleydude">@whatleydude</a> 
					</aside>
				
				</section>

				<section>	
				<h3>History of Furby</h3>
				
				<ol>
					<li>1998: Furby enters the market
					<li>2005: Emoto-tronic Furby, "Furby Island" TV show
					<li>2012: Resurge of the Furby: now with iOS and Android Apps
					<li>2013: 2 Coleman daughters receive Furbies
				    <li>2014: OSCON session: <a href="http://conferences.oreilly.com/oscon/oscon2014/public/schedule/detail/34274">"Arduino + Furby Broken Build Notification - Oh, You'll Want to Fix It Quick!"</a>
					<li>2015: Chewbacca Furby	
					<li>tomorrow... a Furby SkyNet 
				</ol>	

						<aside class="notes">
						Dave Hampton and Caleb Chung - nine months to create the Furby before it appears at the American International Toy Fair in 1998 - citation: http://furbytoyshop.com/furby-history, https://en.wikipedia.org/wiki/Furby

						Image: <a href="https://creativecommons.org/licenses/by/2.0/">Some rights reserved</a> by <a href="https://www.flickr.com/photos/donhomer/">Michael Bentley</a>
						</aside>
				</section>
				<section>
				<h3>Ignoring build notifications</h3>

					<img src="img/geek-and-poke-tests.jpg" height="550px" />
				<aside class="notes">
Image is work of Oliver Widder, oliver@geek-and-poke.com.  I first saw it in stackoverflow posting at http://stackoverflow.com/questions/4085419/am-i-allowed-to-check-in-a-failing-test from Nov 3, 2010
				</aside>
				</section>

				<section data-background="img/8322201790_c303417e89_z.jpg">
					<p>&nbsp;</p>
					<p>&nbsp;</p>
					<p>&nbsp;</p>
					<p>&nbsp;</p>

				<h1>Feel my Furby wrath</h1>
				</section>
<!--
				<section>
					<h3>What.. ?  and WHY??</h3>
					<p>
					Furby for broken code...  <em> Why Not?</em>
					</p>
					<p>Raspberry Pi...  <em>Because I had one</em></p>
					Gobot...  <em>their logo's cool!</em></br><img src="img/gopher.png">
					<br>OK, and so is Golang
					
						<aside class="notes">
						Other build indicators: emails, slack messages, glowing spheres, Nerf guns...  	
						Raspberry Pi - already had an Arduino which I'd done some experimenting with...  always a good idea to try something new, particularly when a conference topic hangs in the balance

						Gobot - well, cool logo, plus I'd gotten to do some Golang at work and wanted to poke around a bit more...  

						Gobot logo: http://gobot.io/images/elements/gopher.png
						</aside>
				</section>
-->
				<section >
					<h3>Labor of Love</h3>
					<a href="http://github.com/colemanserious/furby-gobot">http://github.com/colemanserious/furby-gobot</a>
					<img src="img/9990571563_2d90ca7168_z.jpg" height="500px" />
					
					<aside class="notes">
					Image: <a href="https://creativecommons.org/licenses/by/2.0/">Some rights reserved</a> by <a href="https://www.flickr.com/photos/stevensnodgrass/9990571563">Stephen Snodgrass</a>
				</section>

				<section data-background="img/gophercolor.png"  data-state="dim shift-down" data-background-size="500px 500px" >
					<h3>Go</h3>
					<ul>
						<li>Build smaller modules 
						<li>Fast compile + build time
						<li>Concurrency handling
						<li>Active community
						<li>Built in tooling
						<li>Docker 						
					</ul>
					
					<p></p>
					<h4>Enough to go see what all the fuss is about</h4>
					<aside class="notes">
					The Go gopher was designed by Renee French. (http://reneefrench.blogspot.com/)
	     			The design is licensed under the Creative Commons 3.0 Attributions license.
	     			Read this article for more details: https://blog.golang.org/gopher	
	     			</aside>
				</section>

				<section data-background="img/gobot-home.png" data-state="shift-down" data-background-size="300px 300px">
					<h3>Gobot</h3>
					<ul>	
						<li>Platforms:  Raspberry Pi, BeagleBone, Sphero, Arduino, OpenCV, LeapMotion, ARDrone, Pebble...
						<li> Devices
							<ul>
								<li>GPIO (General Purpose Input/Output)
								<li>I<sup>2</sup>C (Inter-Integrated Circuit)
							</ul>
						<li>Related projects in Ruby (Artoo) and Javascript (Cylon.js)<br />
						<img src="img/artoo.png" /> &nbsp; &nbsp;
						<img src="img/cylon.png" /> 
						<li>Model: Connections, devices, work
					</ul>
					<aside class="notes">
					- All use same adaptor / driver pattern
					- There are some odd things as platforms; joysticks, keyboard, Leap motion
					- Cylon appears to have more "connectors" than Gobot, but able to beg/borrow ideas from all projects
					- Taking a look at the platforms, added a few more things to my Amazon WishList!
					</aside>
					
				</section>

				<section>
					<h3>How DO you control a Furby?</h3>
					<a href="http://dgst201.maryclark.us/hacking/silencing-furby/">Annotated Furby schematics</a>
					<img src="img/_furby_alt_schematic.jpg" height="500px" />
					<aside class="notes">
						* So, Furby's not listed in the set of things that Gobot (or Artoo or Cylon) command...  
						* Instructables to take it apart
						* Motor mechanisms...	

					Image source: http://dgst201.maryclark.us/hacking/silencing-furby/. Blog: MARY CLARK: TINKERING, HACKING, AND MAKING, post as of March 29, 2016.  Linked from http://www.kellyheatonstudio.com/reflection-loop-1
					</aside>
				</section>

				<section>
					<h3>OR...</h3>
					Control using sound
					<img src="img/FurbyGobotPi.svg" height="500px"  />	
					<aside class="notes">
						github.com/iafan/Hacksby - perl project which documents / produces WAV files used to trigger furby
				</section>

				<section>
					<h3>Playing a Sound</h3>
					<pre class="stretch">
					<code data-trim >
// PlayWav plays the filename provided.
// ..
// Note: Did see audio package in golang, however its part of gomobile
//  Other alternatives exist - OpenAL, portaudio, ...  aplay seemed simplest
func PlayWav(fileName string) (err error) {

        if fileName == "" {
                log.Println("Require filename for WAV file.")
                return errors.New("Requires filename for WAV file.")
        }

        // command to play a WAV file on Raspberry Pi
        cmd := exec.Command("aplay", fileName)
        err = cmd.Run()

        if err != nil {
                log.Println(err)
                return err
        }

        // Need to return to fulfill function sig, even though returning an empty
        return
}
					</code>
					</pre>
					
					<aside class="notes">
					- "PlayWav" is public within the package.  See also Command and Run being public.  exec is from package os/exec, which is referred to as its "final" name
					- Common go convention to return err (or array of errors), rather than throw an exception
					- Not yet integrated into Gobot, but this is the basis of what we're doing... 
					</aside>
	
				</section>

				<section>
					<h3>Trying it out - console app</h3>
					<a href="https://github.com/avelino/awesome-go">Awesome Go</a>: 'A curated list of awesome Go frameworks, libraries and software'
					<hr/>

					<a href="https://github.com/spf13/cobra">spf13/cobra</a> - "A Commander for Modern Go CLI interactions"

					
					<pre>
					<code data-trim>
cobra init 
cobra add playSound
					</code>
					</pre>

					<aside class="notes">
					Session earlier this week on Go CLI...  if you didn't catch it, see if it's recorded
					</aside>
				</section>

				<section>
					<h3>playSound command</h3>


Within cmd/playSound.go...
					<pre class="stretch">

					<code>
var playSoundCmd = &cobra.Command{
        Use:   "playSound",
        Short: "Play a sound file given as an argument.",
        Run: func(cmd *cobra.Command, args []string) {

                if len(args) == 0 {
                        log.Println("Must provide filename")
                        return
                }
                err := sounds.PlayWav(args[0])
                if err != nil {
                        log.Println("Unable to execute command - could not play sound.")
                }
        },
}

func init() {
        RootCmd.AddCommand(playSoundCmd)

}

					</code>
					</pre>
					<aside class="notes">
					./furby-gobot playSound resources/match2.wav
					Work done to put Audio into an adaptor and driver for Gobot
					</aside>
				</section>

				<section>
					<h3>Audio Driver / Adaptor</h3>
					Receive requests to play quickly, but only play 1 at a time...<br/>
					Don't block channel, though we might drop playing sounds
					<pre class="stretch">
						<code>
// Use semaphore to control how many sounds might be playing at a time
var sem = make(chan int, 1)

func (d *AudioDriver) Start() (err []error) {
        go d.serve(d.queue)
        return
}

// See example at https://golang.org/doc/effective_go.html#concurrency
// Purpose: receive messages on channel, but throttle execution of playing
func (d *AudioDriver) serve(queue chan string) {
        for req := range queue {
                sem <- 1
                go func(req string) {
                        fmt.Printf("Playing sound %v\n", req)
                        // d.Sound is on Adaptor, which 
                        //  calls aplay using similar logic as PlayWav
                        d.Sound(req)
                        <-sem
                }(req)
        }
}

						</code>
					</pre>
					<aside class="notes">
						Audio is now being added to Gobot, based on work seen here.  This was modeled after the Audio Driver seen in Cylon.
						"if Cylon.js is the future, than Gobot is the future's future" - Ron Evans, @deadprogram, developer at Hybrid Group, the primary maintainers of Gobot
						There's now a feature/audio branch in Gobot, which provides support for mp3s, as well as WAV files
					</aside>
				</section>


				<section>
					<h3>Basic Gobot - Light up LED + sound</h3>
					See cmd/ledOn.go
					<pre class="stretch">
					<code>
gbot := gobot.NewGobot()

r := raspi.NewRaspiAdaptor("raspi")
audioAdaptor := audio.NewAudioAdaptor("sound")

// Gobot maps the pin to the GPIO pin
led := gpio.NewLedDriver(r, "led", "33")

audioDriver := audio.NewAudioDriver(audioAdaptor, "sounds", nil)
         
work := func() {
	gobot.Every(5*time.Second, func() {
	        led.Toggle()
	        audioDriver.Sound("resources/foo.wav")
	})
}

robot := gobot.NewRobot("furbyBot",
    []gobot.Connection{r, audioAdaptor},
    []gobot.Device{led, audioDriver },
    work,
)
					</code>
					</pre>

					<aside class="notes">
						No communications going on between the various components, but GoBot is controlling all of the elements...
					</aside>
				</section>

				<section>
				<h3>Driving via the web</h3>
					<code>
					api.NewAPI(gbot).Start()
					</code>

					<p>&nbsp;</p>
					<p>Any commands on drivers are exposed, as well as events


				</section>

				<section>
				<h3>Web driven</h3>
					<p>Use :3000/ to interact with your robot</p>

					<img src="img/Robeaux.png" height="500px" />

					<aside class="notes">
						http://192.168.2.2:3000
					</aside>
				</section>

				<section>
					<h3>How does Jenkins notify us?</h3>
					<p>
					Job Notification, sending through JSON to a URL
					</p>
					<img src="img/JobNotifications.png" />
					<aside class="notes">
						Sending through as JSON
						Currently sending through all events and filtering in code, but could subset to 'Job Finalized'
						Other demo purpose magic: Fail Build plugin, which lets me control which jobs are succeeding / failing
					</aside>
				</section>

				<section>
				<h3>Integrating info from Jenkins into Gobot</h3>
				Part I: Receive the info.
				<pre class="stretch">
				<code>
j.AddEvent(JobResult)

j.AddCommand("ParseResults", func(params map[string]interface{}) 
	interface{} {
    var snapshot JobOutcomeSnapshot

    result := ParseJobState(params)
    if (JobOutcome{}) != result {
        fmt.Printf("Result: %v\n", result)
        lastOutcome, ok := jobStates[result.Name]
        if ok {
                fmt.Printf("Last outcome: %v\n", lastOutcome)
        }

        snapshot.Outcome = result
        snapshot.RanAt = time.Now()
        jobStates[result.Name] = snapshot
        gobot.Publish(j.Event(JobResult), result)
    }

    return result
})

				</code>
				</pre>
				<aside class="notes">

				All of the above is within my custom jenkinsconnect driver.  Modeled after MQTT...  basically, subscribing to events from Jenkins

				if (JobOutcome{} != result) =>  Did I return a non-empty JobOutcome?  

				gobot.Publish()

				How do I trigger this?  
				</aside>
				</section>

				<section>
				<h3>Integrating info from Jenkins into Gobot</h3>
				Part II: Do something with it...

<pre>
<code>
gobot.On(jenkinsDriver.Event("jobResult"), func(data interface{}) {
	jobResult, ok := data.(jenkinsconnect.JobOutcome)
	if ok {
		switch jobResult.State {
		case jenkinsconnect.SUCCESS:
			furby.ExecuteCommand("burp")
		case jenkinsconnect.FAILED:
			furby.ExecuteCommand("fart")
		default:
		}
	}
})
</code>
</pre>
				</section>

				<section>
					<h3>That furby.ExecuteCommand()</h3>
					<ul>
					<li>FurbyDriver modeled after gpio.LedDriver
					<li>Adds ExecuteCommand()
					</ul>
					<pre class="stretch">
					<code>
// Map command name to file name for command
//  3 digits correspond to code from Hacksby library - see Command.pm
var commands = map[string]string{
	"burp":    "864-burp.wav",
	"fart":    "865-fart.wav",
	"listen":  "820-listen.wav",
	...
}
....
func (f *FurbyDriver) ExecuteCommand(command string) (err error) {

	if !f.State() {
		f.On()
	}

	if file, ok := commands[command]; ok {
		f.soundQueue <- file
		return
	} else {
		return fmt.Errorf("Command %v not available", command)
	}
	return
}

					</code>
					</pre>
					<aside class="notes">
					FurbyDriver "knows" which files to play, and where those are...  It knows _someone's_ listening on a channel to do something with those.  

					Intentionally didn't use events, because wanted to hide this detail away...  
					Left it as ExecuteCommand(string), rather than explicit methods, to make it easier to put the command list tied to the filenames in an external file..  
					</aside>
				</section>

				<section>
				<h3>Show 'em what's broken!</h3>

						Using 16x2 LCD, with RGB colors, show the build status...
						
						<table>
						<tr>
							<td valign="middle">Failing build</td> 
							<td valign="middle"><img src="img/LEDFail.jpg" height="200px"/></td>
						</tr>
						<tr>
							<td valign="middle">Successful build</td>
							<td valign="middle"><img src="img/LEDSuccess.jpg" height="200px" /></td>
						</tr>
						</table>

				</section>
				<section>
				<h3>Final furbyBot - Part 1</h3>

				<pre class="stretch">
				<code>
gbot := gobot.NewGobot()
api.NewAPI(gbot).Start()

r := raspi.NewRaspiAdaptor("raspi")
audioAdaptor := audio.NewAudioAdaptor("sound")
jenkinsAdaptor := jenkinsconnect.NewJenkinsconnectAdaptor("jenkins")

// Set up asynchronous channel - if we get more than 3 sounds being played 
//  in a row, something's up
csoundFiles := make(chan string, 3)
furby := furby.NewFurbyDriver(r, "furby", "16", csoundFiles)
audioDriver := audio.NewAudioDriver(audioAdaptor, "sounds", csoundFiles)
jenkinsDriver := jenkinsconnect.NewJenkinsconnectDriver(jenkinsAdaptor, 
	"jenkins-command")
screen := i2c.NewGroveLcdDriver(r, "screen")

				</code>
				</pre>
				</section>
				<section>
				<h3>Final furbyBot - Part 2</h3>
				<pre class="stretch">
				<code>
work := func() {
	...
	gobot.On(jenkinsDriver.Event("jobResult"), func(data interface{}) {
		jobResult, ok := data.(jenkinsconnect.JobOutcome)
		if ok {
			switch jobResult.State {
			case jenkinsconnect.SUCCESS:
				screen.Home()
				screen.Clear()
				screen.SetRGB(0, 255, 0)
				screen.Write("Success:\n" + jobResult.Name)
				furby.ExecuteCommand("burp")
			case jenkinsconnect.FAILED:
				screen.Home()
				screen.Clear()
				screen.SetRGB(255, 0, 0)
				screen.Write(" FAIL:\n" + jobResult.Name)
				furby.ExecuteCommand("fart")
			default:
			}
		}
	})
}

				</code>
				</pre>
				</section>

				<section>
					<section data-background="img/manyFurbies.jpg" data-state="dim">
					<h1>Oh Developers...</h1>
					
					<p>
							<a href="http://www.nerderypublic.com">Tina Coleman</a> | <a href="http://twitter.com/colemanserious">@colemanserious</a> |
							<a href="mailto:tina@haydensoft.com">tina@haydensoft.com</a>
					</p>
					<p>
					<a href="http://github.com/colemanserious/furby-gobot">http://github.com/colemanserious/furby-gobot</a></p>

					
					</section>
						<section>
						<h3>Resources</h3>
						<ul>
							<li><a href="https://golang.org/doc/effective_go.html">Effective Go</a>
							<li><a href="https://gobot.io/">Gobot.io</a>
							<li><a href="http://awesome-go.com/">http://awesome-go.com</a>: a curated list of Go frameworks, libraries, and software
						</ul>
						</section>
				</section>

			</div>

			<small><a id="talk-tag" href="http://twitter.com/colemanserious">#furbyGobot</a> </small>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<!-- Required for sampler.js! -->
       <script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/reveal-sampler-master/sampler.js'}
				]
			});

		</script>

	</body>
</html>
